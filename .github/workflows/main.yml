name: client

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v3

            - uses: actions/setup-node@v3
              with:
                  node-version: "20" # 21은 non-LTS라 변동/호환 이슈가 가끔 있음
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build
              env:
                  VUE_APP_CHAT_API_URL: ${{ secrets.VUE_APP_CHAT_API_URL }}
              run: npm run build

            - name: Verify dist
              run: |
                  ls -la
                  ls -la dist

            - name: Install AWS CLI
              run: |
                  sudo apt-get update
                  sudo apt-get install -y awscli
                  aws --version

            - name: Sync Bucket
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  AWS_EC2_METADATA_DISABLED: true
              run: |
                  aws s3 sync --region us-east-1 ./dist s3://bidulgirin-portfolio-bucket-26 --delete
